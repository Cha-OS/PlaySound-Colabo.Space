# Creating node.js instance


https://github.com/gc3-uzh-ch/elasticluster/issues/425

https://pypi.python.org/pypi/python-openstackclient

`pip install 'python-novaclient==7.0.0'`

## Colabo.space instance

- Project > Compute > Istances > Launch Instance
  - Details
    - Instance Name: `playsound`
    - Availability Zone: `osl-default-1`
  - Source
    - Select Boot Source: Image
    - Allocated: `GOLD Ubuntu 18.04 LTS`
  - Flavor: `m1.small`
  - Networks: `dualStack`
  - Security Groups
    - add group `ICMP-SSH-HTTP-security-group`
  - Key Pair
    - add the key pair (if it is the only one it will be injected already)
      - `orchestration-iaas-no`
    - you cannot add more than one at this stage
  - **`Launch Instance`**

Test if the *orchestration* machine is alive: `ping <F_IP>`

Try to login to your newly started machine:

- `ssh -i ~/.ssh/<key-name> ubuntu@<F_IP>`
- NOTE: you will not need pass since you use private key instead
- to do something difficult use `sudo command` :), ubuntu is a default user and it is sudoer

## Initial install

```sh
sudo apt-get install joe
```

## Add user related

```sh
sudo groupadd developers
sudo usermod -a -G developers ubuntu
```

## Add Orchestrator user

```sh
sudo useradd -m -d /home/orchestrator  -c "Orchestrator User" -s /bin/bash orchestrator
sudo usermod --lock orchestrator
sudo usermod -a -G developers orchestrator
sudo usermod -a -G sudo orchestrator
sudo mkdir /home/orchestrator/.ssh
sudo chown -R orchestrator:orchestrator /home/orchestrator/.ssh
sudo chmod 700 /home/orchestrator/.ssh
sudo touch /home/orchestrator/.ssh/authorized_keys
sudo chown -R orchestrator:orchestrator /home/orchestrator/.ssh/authorized_keys
sudo chmod 600 /home/orchestrator/.ssh/authorized_keys

sudo printf "\r\n# orchestrator autogenerated by OpenStack DashBoard, added to disk image\r\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDTIJQoJvPt69Mu7TAVSwUqTZqkafu4+3cVcZnJiyeclZiuK3LZNmPHsqM8DhpERSYkMvi3UAQ8FqnCj4+OnBNhyQnc6BXlogmiFHTJ6Az+GraXaSPABxnUYummnMsAWCnHavp7+mQ76dXcj3N/tpJMuAHykTVFp1RvMjoIJQKHj4+u34PJx0mVDYnCmXEJi4Z+GNYyv7CISua1HLTJWgoMMgboHWnj4RMREVNxoyiQNnvdANxl3yQLvKkcdMtlbduuETVxH/otDqHTqgXqrlswIj3dm4Xmdf+/iWTDL1StbFt3HC3GztIRAEtDOdb1HSls8M2B3iWh62Tio16+MzM9 Generated-by-Nova" > /home/orchestrator/.ssh/authorized_keys

sudo printf "\r\n# User rules for orchestrator\r\norchestrator ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/95-no-pass-users
```

Log out and login as orchestrator user

```sh
ping 158.37.63.40
```

__UP TO HERE__


## Installing

```sh
sudo apt-get update
sudo apt-get install joe
sudo apt-get install screen
sudo apt-get install unzip
sudo apt-get install git
sudo apt-get install cowsay
sudo apt-get install fortune
```

### Profile

```sh
joe ~/.bashrc
# add: fortune | cowsay -f tux to ~/.bashrc
source ~/.bashrc
sudo apt-get install gcc
```

### Python related

```sh
sudo apt-get install python-pip
pip install flask
pip install --upgrade pip
```

### Accounts

```sh
sudo groupadd developers
sudo usermod -a -G developers ubuntu
# enable private key authenticated users (so no pass) to run sudo without passes
sudo joe /etc/sudoers.d/95-no-pass-users
# write inside <START>:
# Created by colabo.space-team
# </END>
```

### Web Folders

```sh
sudo mkdir -p /var/www
sudo chown www-data /var/www
sudo chgrp developers /var/www
sudo chmod g+sw /var/www
```

### Creating users

+ [Add a user wthout password but with SSH and public key](https://unix.stackexchange.com/questions/210228/add-a-user-wthout-password-but-with-ssh-and-public-key)
+ https://askubuntu.com/questions/743852/how-to-create-new-user-with-public-key-authentication
+ http://manpages.ubuntu.com/manpages/xenial/en/man8/sshd.8.html
+ sudo without pass
  + [sudo without password when logged in with SSH private keys](https://superuser.com/questions/492405/sudo-without-password-when-logged-in-with-ssh-private-keys)
  + [SSH key auth, but still need password for sudo?](https://security.stackexchange.com/questions/72689/ssh-key-auth-but-still-need-password-for-sudo)

ansimble

```sh
sudo useradd -m -d /home/ansible  -c "Ansible User" -s /bin/bash ansible
sudo usermod --lock ansible
sudo usermod -a -G developers ansible
sudo usermod -a -G sudo ansible
sudo mkdir /home/ansible/.ssh
sudo chown -R ansible:ansible /home/ansible/.ssh
sudo chmod 700 /home/ansible/.ssh
sudo touch /home/ansible/.ssh/authorized_keys
sudo chown -R ansible:ansible /home/ansible/.ssh/authorized_keys
sudo chmod 600 /home/ansible/.ssh/authorized_keys

sudo joe /home/ansible/.ssh/authorized_keys
# write inside <START>
# ansible autogenerated by OpenStack DashBoard, added to disk image
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDTIJQoJvPt69Mu7TAVSwUqTZqkafu4+3cVcZnJiyeclZiuK3LZNmPHsqM8DhpERSYkMvi3UAQ8FqnCj4+OnBNhyQnc6BXlogmiFHTJ6Az+GraXaSPABxnUYummnMsAWCnHavp7+mQ76dXcj3N/tpJMuAHykTVFp1RvMjoIJQKHj4+u34PJx0mVDYnCmXEJi4Z+GNYyv7CISua1HLTJWgoMMgboHWnj4RMREVNxoyiQNnvdANxl3yQLvKkcdMtlbduuETVxH/otDqHTqgXqrlswIj3dm4Xmdf+/iWTDL1StbFt3HC3GztIRAEtDOdb1HSls8M2B3iWh62Tio16+MzM9 Generated-by-Nova
# </END>

sudo joe /etc/sudoers.d/95-no-pass-users
# write inside <START>

# User rules for ansible
ansible ALL=(ALL) NOPASSWD:ALL

# </END>
```

Sasha (mPrinC)

```sh
sudo useradd -m -d /home/mprinc  -c "Sasha Rudan" -s /bin/bash mprinc
sudo usermod --lock mprinc
sudo usermod -a -G developers mprinc
sudo usermod -a -G sudo mprinc

sudo mkdir /home/mprinc/.ssh
sudo chown -R mprinc:mprinc /home/mprinc/.ssh
sudo chmod 700 /home/mprinc/.ssh

sudo touch /home/mprinc/.ssh/authorized_keys
sudo chown -R mprinc:mprinc /home/mprinc/.ssh/authorized_keys
sudo chmod 600 /home/mprinc/.ssh/authorized_keys

sudo joe /home/mprinc/.ssh/authorized_keys
# write inside <START>
# mprinc/sasha autogenerated by OpenStack DashBoard, added to disk image
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDCMJiG4ngrr4riYbK7hPvtmc/glrRtzUsEE5rAvCznjwGkBLhtfBMwWHiA/hG5gED9sUhQp5PZj8BttkyebHRQC19DwNRLyTPEF4PiqNiyN/01HKFVYdc1F4BjnHIjK4rjgk/NQ2kuc0oEyt/LDzPZnLGQnqO2AAWl7oh2Wl+0L9hr+rNOroBBO/5HI+2V80Qm3QkUQdq56ujl40GmI3QIs0Pk8bJUfhs8kiT1ECdTdHzgHblSI1erO2vE4WAOo9BRl+W1wcHDVU09VGpn81ag6qOJatbwFo4JGyS9ZY5vfTshtWtg+8eUyewNII+6dAl0UY0EpDSJhlquNFr79OG/ Generated-by-Nova
# </END>

sudo joe /etc/sudoers.d/95-no-pass-users
# write inside <START>

# User rules for mprinc
mprinc ALL=(ALL) NOPASSWD:ALL

# </END>
```

mirko

```sh
sudo useradd -m -d /home/mirko  -c "Mirko Kovacevic" -s /bin/bash mirko
sudo usermod --lock mirko
sudo usermod -a -G developers mirko
sudo usermod -a -G sudo mirko
sudo mkdir /home/mirko/.ssh
sudo chown -R mirko:mirko /home/mirko/.ssh
sudo chmod 700 /home/mirko/.ssh
sudo touch /home/mirko/.ssh/authorized_keys
sudo chown -R mirko:mirko /home/mirko/.ssh/authorized_keys
sudo chmod 600 /home/mirko/.ssh/authorized_keys

sudo joe /home/mirko/.ssh/authorized_keys
# write inside <START>
# mirko autogenerated by OpenStack DashBoard, added to disk image
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDH25q/fAbgu3ILOcJFICgvxQewyRFn1PVuTWr+pbb/oCSS/jesntlkxEcmBuIINR+llvCKDw2eGGR8ej00Q9W+CVMpNsjKo/Fu9FKyGDyyHzzW+SkOMp40SZHF535AL9rtmUIrotU8aDjDZuhxUpjnuighGIADC9XRANCwGfEB0U69ahhDOLYpYBgLxGuB+J7mwC3hYNBvyTA8lBwghGye7K4y22UdyxBE+azHCBkev/37xgb5yrBGUMCp6+2fej840qfEih1XevANBOjZV8vlfrIP0jpRqi6XSmF20h1OHy0je6cV3vBba0VWcBMpogG0//iwsANijwnruMV+QR0H Generated-by-Nova
# </END>

sudo joe /etc/sudoers.d/95-no-pass-users
# write inside <START>

# User rules for mirko
mirko ALL=(ALL) NOPASSWD:ALL

# </END>
```

Sinisha (sir)

```sh
sudo useradd -m -d /home/sir  -c "Sinisha Rudan" -s /bin/bash sir
sudo usermod --lock sir
sudo usermod -a -G developers sir
sudo usermod -a -G sudo sir
sudo mkdir /home/sir/.ssh
sudo chown -R sir:sir /home/sir/.ssh
sudo chmod 700 /home/sir/.ssh
sudo touch /home/sir/.ssh/authorized_keys
sudo chown -R sir:sir /home/sir/.ssh/authorized_keys
sudo chmod 600 /home/sir/.ssh/authorized_keys

sudo joe /home/sir/.ssh/authorized_keys
# write inside <START>
# sir/sinisha autogenerated by OpenStack DashBoard, added to disk image
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/Rht/N+63SsrT5h3f5ml7YKyU+Zke+QMvdSlEJjI8+fqNqu50WHDXvFSMjKVcGyk8rBT9WorZPOVBeTI/smN2UIxh2w2W7pUtTDSF1LJ5mjXVisAm3A5cSfwweh/X6aNqK6oUs0m8iQ8FtImEeGkalxBFSVMdT7DV3c94dq5i5t88CdlFccnW3LaRF46WPHkRZy938cb1MDzHUtfG+WC/YkE3prPWZzolFo7HTQxXNsckzcvPFZKnwZAImEXBMVbIYXea5B5mrXLZhLK0y3hp9hd179bqNEl3FAoBL3Bfn175cWUq5SuWAbzAf4lf//h9xOx6EvLJVPEHtpYnKHnp Generated-by-Nova
# </END>

sudo joe /etc/sudoers.d/95-no-pass-users
# write inside <START>

# User rules for sir
sir ALL=(ALL) NOPASSWD:ALL

# </END>
```

## Node.js

[Supported Node Versions](https://docs.ghost.org/docs/supported-node-versions)

```
Message: The version of Node.js you are using is not supported.
Supported: ^4.5.0 || ^6.9.0 || ^8.9.0
Installed: 9.5.0
```

So we will install node v8.9.0

[Installing Node.js via package manager](https://nodejs.org/en/download/package-manager/#debian-and-ubuntu-based-linux-distributions)

+ [Install Node.js - Ubuntu](https://ru.godaddy.com/help/install-nodejs-ubuntu-17395)
+ [How To Install Node.js on Ubuntu 16.04](https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-ubuntu-16-04)

**<u>NOTE</u>**: There are different procedures for different major versions

To get the most recent version of Node.js is to add a PPA (**P**ersonal **P**ackage **A**rchive), which is maintained by [NodeSource](https://nodesource.com/).

```sh
# not the 9.x version
# sudo curl -sL https://deb.nodesource.com/setup_9.x | sudo -E bash -
# but the 8.x one
sudo curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -
sudo apt-get install -y nodejs
# Optional: install build tools
# To compile and install native addons from npm you may also need to install build tools:
sudo apt-get install -y build-essential
```

Install **`@angular/cli`**:

```sh
sudo npm install -g @angular/cli
```



### Upgrade

+ [How can I update my nodeJS to the latest version?](https://askubuntu.com/questions/426750/how-can-i-update-my-nodejs-to-the-latest-version)
+ [updating nodejs on ubuntu 16.04](https://stackoverflow.com/questions/41195952/updating-nodejs-on-ubuntu-16-04)
+ https://www.npmjs.com/package/n

We will use **`n`** module from `npm` in order to upgrade node:

```sh
sudo npm cache clean -f
sudo npm install -g n
# installing particular version (6.11.4)
sudo n 6.11.4
# installed as node, not nodejs, under /usr/local/bin/node, not /usr/bin/nodejs
# it is possible to install it in a speciffic folder
```



### Yarn

https://yarnpkg.com/lang/en/docs/install/#debian-stable

```sh
# Note: Ubuntu 17.04 comes with cmdtest installed by default. If you’re getting errors from installing yarn, you may want to run sudo apt remove cmdtest first. Refer to this (https://github.com/yarnpkg/yarn/issues/2821) for more information.
sudo apt remove cmdtest

# configure the repository
curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
sudo apt-get update

# install (without node)
sudo apt-get install --no-install-recommends yarn

# test
yarn --version
```

## Web server

### Apache

https://help.ubuntu.com/lts/serverguide/httpd.html

NOTE: nginx is listening on 80 as well and acting as web server as well. We need to investigate and see if it already fulfills all our needs, since we are less and less relay on heavy dependence on web server.

```sh
sudo apt install apache2

# restart/status/stop
sudo service apache2 stop
sudo service apache2 status
sudo service apache2 restart
```

enabling/disabling

```sh
sudo update-rc.d apache2 disable
sudo update-rc.d apache2 enable
```

### nginx

#### Subdomain

```sh
sudo touch /etc/nginx/sites-available/fv
sudo joe /etc/nginx/sites-available/fv

# <START>
server { 
  listen 80; 
  listen [::]:80; 

  server_name fv.colabo.space;

  root /var/www/fv;
  index index.html;
  autoindex on;

  location / {
    try_files $uri $uri/ /index.html;
  }
}
# <END>

touch /var/www/fv/index.html
joe /var/www/fv/index.html

# check the syntax
sudo rm /etc/nginx/sites-available/fv~
sudo ln -s /etc/nginx/sites-available/fv /etc/nginx/sites-enabled/fv
sudo nginx -t -c /etc/nginx/nginx.conf

sudo service nginx reload
```

## Databases

### MySQL

[A Quick Guide to Using the MySQL APT Repository](https://dev.mysql.com/doc/mysql-apt-repo-quick-guide/en/)

+ go to the https://dev.mysql.com/downloads/repo/apt/
+ and at the bottom find the **download** link
+ then just right-click on the `No thanks, just start my download.` and copy url
+ use the url in the **`wget command`**

```sh
# download the release package
wget https://dev.mysql.com/get/mysql-apt-config_0.8.9-1_all.deb
# Install the downloaded release package
sudo dpkg -i mysql-apt-config_0.8.9-1_all.deb
	# choose the versions and packages
	# MySQL Server & Cluster (Currently selected: mysql-5.7)
# Update package information from the MySQL APT repository
sudo apt-get update
# Installing MySQL with APT
sudo apt-get install mysql-server
	# You will need to provide the root password
```

**<u>NOTE</u>**: version mysql-5.7 was installed

- [RackSpace - Install MySQL Server on Ubuntu](https://support.rackspace.com/how-to/installing-mysql-server-on-ubuntu/)
  - more detailed (Allow remote access, creating dbs, tables, users, …)
- https://en.wikipedia.org/wiki/MySQL#Release_history
- https://en.wikipedia.org/wiki/MariaDB
- https://help.ubuntu.com/lts/serverguide/mysql.html
- [DigitalOcean - How To Install MySQL on Ubuntu 16.04](https://www.digitalocean.com/community/tutorials/how-to-install-mysql-on-ubuntu-16-04)

#### Starting and Stopping the MySQL Server

```sh
sudo service mysql status
sudo service mysql start
sudo service mysql stop
```

#### Updating Major version

You can switch to **another supported major release series** at any time by **reconfiguring** the configuration package you have installed

```sh
# reconfiguring the configuration package
sudo dpkg-reconfigure mysql-apt-config
```

### Mongo

[Install MongoDB Community Edition on Ubuntu](https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/)

**config**: `/etc/mongod.conf`

***<u>NOTES</u>***: 

+ MongoDB only provides packages for 64-bit LTS (long-term support) Ubuntu releases. For example, 12.04 LTS (precise), 14.04 LTS (trusty), 16.04 LTS (xenial), and so on. These packages may work with other Ubuntu releases, however, they are not supported.
+ The default `/etc/mongod.conf` configuration file supplied by the packages have `bind_ip` set to `127.0.0.1` by default. Modify this setting as needed for your environment before initializing a [replica set](https://docs.mongodb.com/manual/reference/glossary/#term-replica-set)


#### Install

```sh
# Import the public key used by the package management system
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 2930ADAE8CAF5059EE73BB4B58712A2291FA4AD5

# Create a list file for MongoDB
# Create the /etc/apt/sources.list.d/mongodb-org-3.6.list list file
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.6 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-3.6.list

# Reload local package database
sudo apt-get update

# Install the MongoDB packages
## A) Install the latest stable version of MongoDB or ...
sudo apt-get install -y mongodb-org

## B) Install a specific release of MongoDB
sudo apt-get install -y mongodb-org=3.6.4 mongodb-org-server=3.6.4 mongodb-org-shell=3.6.4 mongodb-org-mongos=3.6.4 mongodb-org-tools=3.6.4
```

#### Run/Restart/Stop

```sh
# Start MongoDB
sudo service mongod start

# Verify that MongoDB has started successfully
cat /var/log/mongodb/mongod.log
grep "waiting for connections" /var/log/mongodb/mongod.log

# restart/status/stop
sudo service mongod stop
sudo service mongod status
sudo service mongod restart
```

#### Test

[reference/mongo-shell](https://docs.mongodb.com/manual/reference/mongo-shell/)

```sh
mongo --host 127.0.0.1:27017
show dbs
use testDb
show collections
d = { Name : "Test User" }
db.testData.insert( d );
show dbs
show collections
db.dropDatabase();
```

Log:

```txt
Server has startup warnings: 
2018-05-07T11:32:48.310+0000 I STORAGE  [initandlisten] 
2018-05-07T11:32:48.310+0000 I STORAGE  [initandlisten] ** WARNING: Using the XFS filesystem is strongly recommended with the WiredTiger storage engine
2018-05-07T11:32:48.310+0000 I STORAGE  [initandlisten] **          See http://dochub.mongodb.org/core/prodnotes-filesystem
2018-05-07T11:32:49.121+0000 I CONTROL  [initandlisten] 
2018-05-07T11:32:49.121+0000 I CONTROL  [initandlisten] ** WARNING: Access control is not enabled for the database.
2018-05-07T11:32:49.121+0000 I CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.
2018-05-07T11:32:49.121+0000 I CONTROL  [initandlisten]
```

#### MongoChef

Server:

<img alt="MongoChef - 01 - server" src="MongoChef - 01 - server.png" width="50%"/>

SSH Tunnel:

<img alt="MongoChef - 01 - SSH Tunnel" src="MongoChef - 01 - SSH Tunnel.png" width="50%"/>

#### Access rights

https://ianlondon.github.io/blog/mongodb-auth/

Others:
https://docs.mongodb.com/tutorials/connect-to-mongodb-shell/
https://ianlondon.github.io/blog/mongodb-auth/
https://stackoverflow.com/questions/7159737/getting-mongodb-on-linux-to-listen-to-remote-connections
https://docs.mongodb.com/manual/tutorial/configure-linux-iptables-firewall/
https://www.mkyong.com/mongodb/mongodb-allow-remote-access/
https://www.mongodb.com/blog/post/enabling-ip-security-for-mongodb-36-on-ubuntu
https://www.garron.me/en/bits/iptables-open-port-for-specific-ip.html

```
sudo joe /etc/mongod.conf
# commented
# bindIp: 127.0.0.1
# added
bindIp: 127.0.0.1, 158.39.75.120

bindIp: 127.0.0.1, 158.39.75.120, 172.17.0.1

sudo netstat -plant | egrep mongod
ifconfig
sudo service mongod restart
sudo iptables -A INPUT -p tcp --dport 27017 -j ACCEPT
mongo --host localhost:27017
mongo --host 127.0.0.1:27017
mongo --host 158.39.75.120:27017

> show databases
> use KnAllEdge
> show tables
```

### Colabo code

#### Create

```sh
sudo mkdir /var/repos
sudo chown -R mprinc:developers /var/repos
sudo chmod 775 /var/repos
sudo chmod g+s /var/repos
cd /var/repos
git clone https://github.com/Cha-OS/colabo
```

#### Install frontend

##### nginx

https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/#front-controller-pattern-web-apps

```nginx
location /knalledge-view-node/ {
  # alias /var/www/html//knalledge-view-node/dist/;
  # try_files $uri$args $uri$args/ /knalledge-view-node/index.html;
  try_files $uri $uri/ /knalledge-view-node/index.html;
}
```

```sh
# check the syntax
sudo rm /etc/nginx/sites-enabled/default~
sudo nginx -t -c /etc/nginx/nginx.conf

sudo service nginx reload
```

#### Install backend
(NOTE on OSX: `brew install wget`)

```sh
cd /var/repos/colabo/src/backend/
yarn
cd node_modules
rm -r express-resource
rm -r deep-assign
wget http://colabo.space/downloads/express-resource.zip
wget http://colabo.space/downloads/deep-assign.zip
unzip express-resource.zip
unzip deep-assign.zip
cd ../modules/topiChat
yarn
cd ../topiChat-knalledge
yarn
cd ../..
```

#### Update backend

```sh
cd /var/repos/colabo/src/backend/
git pull
sudo systemctl status knalledge-b.service
sudo systemctl restart knalledge-b.service
sudo systemctl status knalledge-b.service
```

#### database population

Connect through MongoChef to the Mongo server and create the **`KnAllEdge`** database and add collections: `kmaps`, `knodes`, `kedges`.

reference/mongo-shell](https://docs.mongodb.com/manual/reference/mongo-shell/)

```js
mongo --host 127.0.0.1:27017
show dbs
use KnAllEdge
show collections
dMap = {
    "_id" : ObjectId("f7baf6923c0c84b84f0d402a"),
    "name" : "Play Perform Learn Grow Conference 2018 - Thessaloniki",
    "rootNodeId" : ObjectId("f7baf6913c0c84b84f0d4028"),
    "type" : "CollaboArte",
    "iAmId" : ObjectId("556760847125996dc1a4a241"),
    "ideaId" : NumberInt(0),
    "parentMapId" : "",
    "dataContent" : null,
    "__v" : NumberInt(0),
    "isPublic" : false,
    "participants" : [
    ],
    "version" : NumberInt(1),
    "activeVersion" : NumberInt(1)
}
db.kmaps.insert( dMap );
show dbs
show collections


dNode = { 
    "_id" : ObjectId("5ae4fa5f53aefac127695f66"), 
    "name" : "Пасуљ", 
    "type" : "type_knowledge", 
    "mapId" : ObjectId("579712998e12abfa556f6ad6"), 
    "iAmId" : ObjectId("556760847125996dc1a4a241"), 
    "ideaId" : NumberInt(0), 
    "updatedAt" : ISODate("2018-04-28T22:49:03.790+0000"), 
    "createdAt" : ISODate("2018-04-28T22:49:03.776+0000"), 
    "visual" : {
        "isOpen" : false
    }, 
    "isPublic" : true, 
    "version" : NumberInt(1), 
    "activeVersion" : NumberInt(1), 
    "__v" : NumberInt(0), 
    "decorations" : {

    }, 
    "up" : {

    }, 
    "dataContent" : {
        "propertyType" : "text/markdown", 
        "property" : "# Рецепт\n\n[06.05.14 22:22:20] mama: \n+ GRAH SE PRAVI OVAKO\n+ GRAH SE PRAVI OVAKO, UVECE U HLADNU VODU POTOPIS S PUNO VODE GRAH STO MISLIS KUHATI\n+ PA SUTRA OPERES I STAVIS DA NA LAGANO POCNE DA SE DIZE PJENA, UGASIS I MALO NA TOPLOJ RINGLI OSTAVIS, PA OPERES GRAH\n+ ZATIM STAVIS GRAH KUVATI DO KLJUCANJA NA JACE, KADA POCNE KUVATI ONDA SMANJIS NA LAGANO SKROZ KUVANJE\n+ DODAS, SJECKANOG LUKA CRNOG I BIJELOG, MRKVE I STO JOS ZELIS, \n+ LOVOR, PAPRA, \n+ STAVIS I CELERA KORIJEN, LIST, LIST PERSUNA ITD\n+ A I MOZE ZAPRSKA\n\t+ A MOZES DA U POSUDI U 1 DCL VODE TOPLE STAVIS, RAZMUTIS 2 ZLICICE BJELOG BRASNA I 2 ZLICICE MLJEVENE PAPRIKE I TO DOBRO RAZMUTIS I STAVIS U GRAH KADA JE SKORO KUHAN I DOBRO PROMJESAJ SVE\n+ TO SE SVE POLAKO DO KRAJA KUHA DOK GRAH NIJE TVRD, ODNOSNO DA NE RASPADNE SE\n\t+ ONDA DOBIJES KAO TIJESTO\n\t+ BOLJE DA IPAK IMA SVOJ OBLIK\n+ DODAS SOLI NA KRAJU I VEGETE\n\t+ ALI NEMOJ PRETJERIVATI, BOLJE JE DA JE MANJE, SLANO\n\t+ A TO ZAVISI I OD SUHOMESNATOG STO SI STAVIO\n\t+ ZNACI SO I VEGETA NA KRAJU\n\t+ BOLJE OSTAVITI MANJE SLANO I KASNIJE DOSOLITI.\n\n[06.05.14 22:22:38] mama: \n+ MISLIM DA SAM TI OBJASNILA DONEKLE, MOZDA I PREOPSIRNO AL...\n+ BITNO GA JE NA LAGANO I SIROJ RANGLI KUVATI, MOZDA I POKLOPLJEN, U NJEGOVOJ PARI\n+ ALI SKROZ ONDA LAGANO I DUZE, DA NE IZADJE U PARI SLAST\n+ Грах се прокуха да баци пар пута воду, након тога се остави да се охлади у тој води и онда се пропере.\n\n# Детаљи\n\nСаша: Пребаци се на 3 температура. Дода се со.\n\nНакон тога се поново куха и стави у њега КРОМПИР и ЛУК. (Саша: а мркву када?)\n\nМЕСО:\n--------\nАко се ставља \"сељачко\" месо онда се ставља на почетку.\n\nДОДАЦИ:\n--------\nУ грах се додаје БРОКОЛИ или КЕЉ и то прије запрешке\n\nДОДАВАЊЕ ВОДЕ:\n---------------\nУ грах се додаје врућа вода, јер ако се додаје хладна онда ће се дуже кухати што није добро. Грах се куха и додаје вода колико треба да се добије жељена густина.\n\nЗАПРЕШКА:\n--------\nКада се грах омекша онда се у њега ставља запрешка\n\n2 жлице УЉА у таву, жлицу БРАШНА и то се врти, врти и мјеша док мало не пожути то брашно.\n\nКад пожути, насјецка се ЛУКА ситно црнога и бјелога док то не омекша. Када то омекша дода се жличица црвене ПАПРИКЕ или више, зависно од боје, и када се то дода одмах се додаје жупица из граха да то не би загорило.\n\nОнда се то готово одмах и убаци натраг у лонац.\n\nТава се сапере и стави се све у лонац.\n\nНАКОН ЗАПРЕШКЕ:\n----------------\n\nНакон запрешке се куха лагано да не загори још петнаестак минута док се не види да је готов. У грах се дода ЛОВОР, БИБЕР, ВЕГЕТЕ, СО, МИРОЂИЈЕ по укусу.\n\nЧУВАЊЕ:\n----------\nНе стављати врућ грах у фриждер већ када се охлади да се не би покварио.\n\n===\n\n# Од Раније детаљно\n\n[06.05.14 22:13:06] Sasha: ali u receptu nisam zapisao da se smanji temperatura nakon prve vode pa mi je prosli put zagorio bas, a sada sam smanjio na 3 i kasnije na 2 pa je bio bas odlican\n\n[06.05.14 22:22:20] mama: GRAH SE PRAVI OVAKO, UVECE U HLADNU VODU POTOPIS S PUNO VODE GRAH STO MISLIS KUHATI, PA SUTRA OPERES I STAVIS DA NA LAGANO POCNE DA SE DIZE PJENA, UGASIS I MALO NA TOPLOJ RINGLI OSTAVIS, PA OPERES GRAH. ZATIM STAVIS GRAH KUVATI DO KLJUCANJA NA JACE, KADA POCNE KUVATI ONDA SMANJIS NA LAGANO SKROZ KUVANJE, DODAS, SJECKANOG LUKA CRNOG I BIJELOG, MRKVE I STO JOS ZELIS, LOVOR, PAPRA, A I MOZE ZAPRSKA, A MOZES DA U POSUDI U 1 DCL VODE TOPLE STAVIS, RAZMUTIS 2 ZLICICE BJELOG BRASNA I 2 ZLICICE MLJEVENE PAPRIKE I TO DOBRO RAZMUTIS I STAVIS U GRAH KADA JE SKORO KUHAN I DOBRO PROMJESAJ SVE, STAVIS I CELERA KORIJEN, LIST, LIST PERSUNA ITD, TO SE SVE POLAKO DO KRAJA  KUHA DOK GRAH NIJE TVRD, ODNOSNO DA NE RASPADNE SE, ONDA DOBIJES KAO TIJESTO, BOLJE DA IPAK IMA SVOJ OBLIK. DODAS SOLI NA KRAJU I VEGETE, ALI NEMOJ PRETJERIVATI, BOLJE JE DA JE MANJE, SLANO, A TO ZAVISI I OD SUHOMESNATOG STO SI STAVIO, ZNACI SO I VEGETA NA KRAJU, BOLJE OSTAVITI MANJE SLANO I KASNIJE DOSOLITI.\n\n[06.05.14 22:22:38] mama: MISLIM DA SAM TI OBJASNILA DONEKLE, MOZDA I PREOPSIRNO AL...\n\n[06.05.14 22:26:39] mama: BITNO GA JE NA LAGANO I SIROJ RANGLI KUVATI, MOZDA I POKLOPLJEN, U NJEGOVOJ PARI, ALI SKROZ ONDA LAGANO I DUZE, DA NE IZADJE U PARI SLAST"
    }
}

db.knodes.insert( dNode );

dNode = { 
    "_id" : ObjectId("5af39ce82843ddf04b459cae"), 
    "name" : "Poesia in strada - Collaborazione poetica sui rifugiati", 
    "type" : "model_component", 
    "mapId" : ObjectId("5af39ce82843ddf04b459cb0"), 
    "iAmId" : ObjectId("556760847125996dc1a4a24f"), 
    "ideaId" : NumberInt(0), 
    "updatedAt" : ISODate("2018-05-10T01:14:16.063+0000"), 
    "createdAt" : ISODate("2018-05-10T01:14:16.061+0000"), 
    "visual" : {
        "isOpen" : true, 
        "yM" : NumberInt(0), 
        "xM" : NumberInt(0)
    }, 
    "isPublic" : true, 
    "version" : NumberInt(1), 
    "activeVersion" : NumberInt(1), 
    "__v" : NumberInt(0), 
    "decorations" : {

    }, 
    "up" : {

    }, 
    "dataContent" : {
        "propertyType" : "text/markdown", 
        "property" : "Welcome to CoLaboArthon"
    }
}
db.knodes.insert( dNode );

show dbs
show collections
```

#### Run

```sh
sudo -u www-data /usr/bin/nodejs /var/repos/colabo/src/backend/KnAllEdgeBackend.js 8001 8002

wget http://fv.colabo.space/api/kmaps/all.json
wget http://localhost:8001/kmaps/all.json
wget http://localhost:8001/whatAmIs/all.json
wget http://localhost:8001/knodes/one/default/5ae4fa5f53aefac127695f66
wget http://localhost:8001/knodes/one/default/5af39ce82843ddf04b459cae
```

#### Obsolated - Installing as a service (upstream - obsolated, see the following systemd version)

```sh
sudo joe /etc/init/knalledge-b.conf
```

```txt
description "Colabo.Space Backend (node.js)"
author "Sasha Mile Rudan"

# When to start the process
start on runlevel [2345]

# When to stop the process
# 0-Halt, 1-Single-user Mode, 6-Reboot
stop on runlevel [016]

# The process to start
# it is important that script can be started out of its own folder
# with something like: process.chdir(__dirname);
exec sudo -u www-data /usr/bin/nodejs /var/repos/colabo/src/backend/KnAllEdgeBackend.js 8001 8002

# Restart the process if it is down
respawn

# Limit restart attempt to 10 times within 10 seconds
respawn limit 10 10
```

testing:

```sh
start knalledge-b
restart knalledge-b
stop knalledge-b
status knalledge-b
```

#### Installing as a service (SystemD)

https://wiki.ubuntu.com/SystemdForUpstartUsers
https://www.digitalocean.com/community/questions/convert-run-at-startup-script-from-upstart-to-systemd-for-ubuntu-16
https://askubuntu.com/questions/626771/migrate-basic-upstart-script-to-systemd
https://www.freedesktop.org/wiki/Software/systemd/

```sh
sudo joe <local>/knalledge-b.service
sudo ln -s /etc/systemd/system/knalledge-b.service
```

```txt
[Unit]
Description=Colabo.Space Backend (node.js)

[Service]
Environment= MY_ENVIRONMENT_VAR =/path/to/file.config
WorkingDirectory=/var/repos/colabo/src/backend/apps/colabo-space/dist/
ExecStart=/usr/bin/nodejs /var/repos/colabo/src/backend/apps/colabo-space/dist/index.js 8001 8002
Restart=always

[Install]
WantedBy=multi-user.target
```

Run and test:

```sh
sudo systemctl daemon-reload
sudo systemctl enable knalledge-b.service
sudo systemctl start knalledge-b.service
sudo systemctl stop knalledge-b.service
sudo systemctl status knalledge-b.service
```

#### NGINX passing through HTTPS

Aim is to redirect https://fv.colabo.space/api/kmaps/all.json into http://localhost:8001/kmaps/all.json

[Configuring Nginx and SSL with Node.js](https://www.sitepoint.com/configuring-nginx-ssl-node-js/)

redirecting subfolder to internal service
+ https://gist.github.com/nikmartin/5902176
+ https://www.digitalocean.com/community/questions/how-to-setup-nginx-reverse-proxy-for-sub-domain
+ https://www.digitalocean.com/community/questions/how-to-setup-nginx-reverse-proxy-for-sub-domain
+ https://stackoverflow.com/questions/4449788/how-to-redirect-address-com-foo-bar-to-address-comport-bar-with-nginx

rewriting URL path forwarded to the proxied server (API)
  + https://serverfault.com/questions/379675/nginx-reverse-proxy-url-rewrite
  + https://stackoverflow.com/questions/32542282/how-do-i-rewrite-urls-in-a-proxy-response-in-nginx

```sh
sudo joe /etc/nginx/sites-available/fv
# Add under server

# map the API into a subfolder of the subdomain `fv.colabo.space`
location /api/ {
  # take out the `api/` part from the forwarded url
  rewrite /api/(.*) /$1  break;
  # THESE ARE IMPORTANT
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

  # This is what tells Connect that your session can be considered secure, 
  # even though the protocol node.js sees is only HTTP:        
    proxy_set_header X-Forwarded-Proto $scheme; 

    proxy_set_header Host $http_host;
    proxy_set_header X-NginX-Proxy true;
    proxy_read_timeout 5m;
    proxy_connect_timeout 5m;
    # redirect to the local node.js service listening on the 8001 port
    proxy_pass http://127.0.0.1:8001;
    proxy_redirect off;
}

sudo nginx -t -c /etc/nginx/nginx.conf
sudo service nginx reload
```

check: https://fv.colabo.space/api/kmaps/all.json