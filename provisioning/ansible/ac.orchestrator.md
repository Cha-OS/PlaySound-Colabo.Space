## Orchestrator Instance

First you need to create an ***orchestrator instance*** manually. This should be as light as possible instance, since it is not for heavy computation.

Here is a short summing up:

+ Project > Compute > Istances > Launch Instance
  - Details
    - Instance Name: `ac-orchestrator`
    - Availability Zone: `osl-default-1`
  - Source
      - Select Boot Source: Image
      - Allocated: `GOLD Ubuntu 16.04 LTS`
        - the `GOLD Ubuntu 17.10` is not Xenial, so open stack orchestration is not supported
      - Volume Size (GB): 3 (Image is > 2 Gb so this is the minimum :( )
  - Flavor: `m1.small`
  - Networks: `dualStack`
  - Security Groups
    - add groups `ICMP-SSH-HTTP-HTTPS-security-group` and `queue-broker`
  - Key Pair
    - add your key pair (if it is the only one it will be injected already)
    - you cannot add more than one at this stage
  - **`Launch Instance`**

Test if the *orchestration* machine is alive: `ping <F_IP>`

Try to login to your newly started machine:
+ `ssh -i ~/.ssh/<key-name> ubuntu@<F_IP>`
+ NOTE: you will not need pass since you use private key instead
+ to do something difficult use `sudo command` :), ubuntu is a default user and it is sudoer

## Initial install

```sh
sudo apt-get install joe
```

## Install locale

```sh
sudo dpkg-reconfigure locales
    # go to the page with text: "Default locale for the system environment: "
    # and choose en_US.UTF-8
# This might be necessary to run on every login
# or to put it in a user startup sequence
export LC_ALL="en_US.UTF-8"
export LC_CTYPE="en_US.UTF-8"
```

## Add user related

```sh
sudo groupadd developers
sudo usermod -a -G developers ubuntu
```

## Add Orchestrator user

```sh
sudo useradd -m -d /home/orchestrator  -c "Orchestrator User" -s /bin/bash orchestrator
sudo usermod --lock orchestrator
sudo usermod -a -G developers orchestrator
sudo usermod -a -G sudo orchestrator
sudo mkdir /home/orchestrator/.ssh
sudo chown -R orchestrator:orchestrator /home/orchestrator/.ssh
sudo chmod 700 /home/orchestrator/.ssh
sudo touch /home/orchestrator/.ssh/authorized_keys
sudo chown -R orchestrator:orchestrator /home/orchestrator/.ssh/authorized_keys
sudo chmod 600 /home/orchestrator/.ssh/authorized_keys

sudo joe /home/orchestrator/.ssh/authorized_keys
# write inside <START>
# orchestrator autogenerated by OpenStack DashBoard, added to disk image
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDTIJQoJvPt69Mu7TAVSwUqTZqkafu4+3cVcZnJiyeclZiuK3LZNmPHsqM8DhpERSYkMvi3UAQ8FqnCj4+OnBNhyQnc6BXlogmiFHTJ6Az+GraXaSPABxnUYummnMsAWCnHavp7+mQ76dXcj3N/tpJMuAHykTVFp1RvMjoIJQKHj4+u34PJx0mVDYnCmXEJi4Z+GNYyv7CISua1HLTJWgoMMgboHWnj4RMREVNxoyiQNnvdANxl3yQLvKkcdMtlbduuETVxH/otDqHTqgXqrlswIj3dm4Xmdf+/iWTDL1StbFt3HC3GztIRAEtDOdb1HSls8M2B3iWh62Tio16+MzM9 Generated-by-Nova
# </END>

sudo joe /etc/sudoers.d/95-no-pass-users
# write inside <START>

# User rules for orchestrator
orchestrator ALL=(ALL) NOPASSWD:ALL

# </END>
```

Log out and login as orchestrator user

## Install ansible

```sh
sudo apt-get update
sudo apt-get install python-pip
python -m pip install --upgrade pip
sudo -H python -m pip install virtualenv
sudo -H python -m pip install ansible
```

## Config ansible

```sh
sudo mkdir -p /etc/ansible
sudo joe /etc/ansible/hosts
```

```yaml
all:
hosts:
  children:

    orchestrators:
      hosts:
        orchestrator-1:
            ansible_host: 158.37.63.132
            ansible_port: 22

    mediators:
      hosts:
        mediator-1:
            ansible_host: 158.37.63.127
            ansible_python_interpreter: /usr/bin/python3
    
    services:
      hosts:
        service-1:
            ansible_host: 158.37.63.53
            ansible_python_interpreter: /usr/bin/python3
```

## Installing orchestrator

```sh
sudo apt-get update
sudo apt-get install joe
sudo apt-get install screen
sudo apt-get install git
sudo apt-get install cowsay
sudo apt-get install fortune
sudo mkdir -p /var/www
sudo chown www-data /var/www
sudo chgrp developers /var/www
sudo chmod g+sw /var/www
joe ~/.bashrc
# add lines:
fortune | cowsay -f tux to ~/.bashrc
```

language:

```sh
# export LC_ALL=C
    export LC_ALL="en_US.UTF-8"
    export LC_CTYPE="en_US.UTF-8"
    sudo dpkg-reconfigure locales
# default: en_US.UTF-8 
```

```sh
source ~/.bashrc
sudo apt-get install gcc
```

### Python related

```sh
sudo apt-get install python-pip
pip install flask
pip install --upgrade pip
```

## Put happy welcome service:

### Fixing error with running python as `www-data` (missing flak module)

**<u>NOTE</u>**: This was necessary for Umeå

ugly fix, need to figure out:

Add bash as login for the www-data user
```sh
sudo joe /etc/passw # set it to /bin/bash

sudo su www-data
python /var/www/app.py
pip install flask
python /var/www/app.py
exit

sudo joe /etc/passw # return back to /usr/sbin/nologin

sudo su # do it for root as well (that helped)
pip install flask
exit
```
### Fixing problem with error running shell program

**<u>NOTE</u>**: This is necessary just to enable test web service. you can skip it to speed up

https://unix.stackexchange.com/questions/40719/stay-at-same-working-directory-when-changing-to-sudo


### Creating service


+ create a new `app.py` file
+ `joe /var/www/app.py`

```python
from flask import Flask, jsonify, Response
import subprocess
import sys

app = Flask(__name__)

# @app.route('/cowsay/api/v1.0/saysomething', methods=['GET'])
@app.route('/', methods=['GET'])
def cow_say():
    # data=subprocess.check_output(["./fortunecow.sh"])
    # data=subprocess.check_output(["cowsay","Hello student"])
    fortune=subprocess.check_output(["fortune"])
    data=subprocess.check_output(["cowsay", "-f", "tux", fortune])
    # data=subprocess.check_output(["./fortunecow.sh"])
    # return data
    return Response(data, mimetype='text/text')

if __name__ == '__main__':

    app.run(host='0.0.0.0', port=5000, debug=True)
```

### Test
+ run it `python app.py`
+ test it, either `curl -i http://localhost:5000/cowsay/api/v1.0/saysomething`
+ or `curl -i http://localhost:5000/`
+ run it as `www-data` user `python app.py`: `sudo -u www-data python /var/www/app.py`

### Provide it outside

we will forward external port 80 to local 5000 port where our service is listening. We will do it in `iptables` and with cron we protect us against rebooting

```sh
sudo joe /etc/rc.local
```
place:
```sh
iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 5000
exec sudo -u www-data python /var/www/app.py
```

Enable it
```sh
sudo chown root /etc/rc.local
sudo chmod 755 /etc/rc.local
sudo /etc/init.d/rc.local start
# if necessary:
sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 5000
```

Check services and ports: `http://<F_IP>`

### Adding openstack API support

+ https://wiki.ubuntu.com/OpenStack/CloudArchive
  + old: https://wiki.ubuntu.com/ServerTeam/CloudArchive

```sh
sudo apt-get install software-properties-common
# Ubuntu Cloud Archive for OpenStack Pike
# More info: https://wiki.ubuntu.com/ServerTeam/CloudArchive
sudo add-apt-repository cloud-archive:pike
	# cloud-archive for Pike only supported on xenial :(
sudo apt update && apt dist-upgrade # for some reason I needed to do explicit `sudo su` first and then proceed
# sudo apt-get install python-openstackclient
sudo apt-get install python3-openstackclient
sudo pip install python-openstackclient
sudo pip install python-openstacksdk
pip freeze
```

```
openstacksdk==0.11.2

python-cinderclient==3.5.0
python-glanceclient==2.9.1
python-keystoneclient==3.15.0
python-novaclient==10.1.0
python-openstackclient==3.14.0
python-openstacksdk==0.5.2
```

Download the Runtime Configuration (RC) file from the SSC site (Project->Compute->Access & Security->API Access->Download OpenStack RC File)

place it in your environment,
```sh
mkdir ~/SNIC
joe ~/SNIC/2017-13-52-openrc.sh
```

Add content of the downloaded file, but also add missing var OS_PROJECT_DOMAIN_NAME: `export OS_PROJECT_DOMAIN_NAME="snic"`

Execute it: `source ~/SNIC/2017-13-52-openrc.sh`

It will ask you for the API password. In this way it will not be stored in the file system, but be only present in the system memory.

TODO: Write how to retrieve API password.

Test if it is working fine:
```sh
openstack server list
openstack image list
```

### Adding the `fdb-deployment` repository to the `orchestrator` server

`git clone https://git.cs.umu.se/sasha/fdb-deployment`
# Creating Ghost Blog

-   Project > Compute > Istances > Launch Instance
    -   Details
        -   Instance Name: `colabo-ghost`
        -   Availability Zone: `osl-default-1`
    -   Source
        -   Select Boot Source: Image
        -   Allocated: `GOLD Ubuntu 16.04 LTS`
            -   the `GOLD Ubuntu 17.10` is not Xenial, so open stack orchestration is not supported
            -   ​
        -   Volume Size (GB): 3 (Image is > 2 Gb so this is the minimum :( )
    -   Flavor: `m1.medium`
    -   Networks: `dualStack`
    -   Security Groups
        -   add group `ICMP-SSH-HTTP-security-group`
    -   Key Pair
        -   add your key pair (if it is the **only one** it will be injected already)
        -   you cannot add more than one at this stage
    -   **`Launch Instance`**

Info

```sh
# name
colabo-ghost
# IP
158.39.75.121
```

Test if the *orchestration* machine is alive: `ping <F_IP>`

Try to login to your newly started machine:

-   `ssh -i ~/.ssh/<key-name> ubuntu@<F_IP>`
-   NOTE: you will not need pass since you use private key instead
-   to do something difficult use `sudo command` :), ubuntu is a default user and it is sudoer

### Installing

```sh
sudo apt-get update
sudo apt-get install joe
sudo apt-get install screen
sudo apt-get install git
sudo apt-get install cowsay
sudo apt-get install fortune
sudo groupadd developers
sudo usermod -a -G developers ubuntu
sudo mkdir -p /var/www
sudo chown www-data /var/www
sudo chgrp developers /var/www
sudo chmod g+sw /var/www
joe ~/.bashrc
# add lines:
fortune | cowsay -f tux to ~/.bashrc
export LC_ALL=C
```



```sh
source ~/.bashrc
sudo apt-get install gcc
```

### Python related

```sh
# https://stackoverflow.com/questions/36394101/pip-install-locale-error-unsupported-locale-setting
export LC_ALL=c
sudo apt-get install python-pip
pip install flask
pip install --upgrade pip
```

### Node.js

```sh
# not the 9.x version
# sudo curl -sL https://deb.nodesource.com/setup_9.x | sudo -E bash -
# but the 8.x one
sudo curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -
sudo apt-get install -y nodejs
# Optional: install build tools
# To compile and install native addons from npm you may also need to install build tools:
# should be similar to: `sudo apt-get install gcc g++ make`
sudo apt-get install -y build-essential

## To install the Yarn package manager, run
curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
sudo apt-get update && sudo apt-get install yarn
```

### RabbitMQ

https://www.rabbitmq.com/install-debian.html

Linux version, repo, etc:

```sh
uname -a
cat /etc/*-release
lsb_release
cat /proc/version
```

#### Install ERLANG

https://www.rabbitmq.com/which-erlang.html

##### Installing v1

**NOTE**: This is not working, some libs are missing

https://www.vultr.com/docs/how-to-install-rabbitmq-on-ubuntu-16-04-47
https://www.digitalocean.com/community/tutorials/how-to-install-and-manage-rabbitmq

```sh
# find the path on https://packages.erlang-solutions.com/erlang/#tabs-debian
# download it
wget http://packages.erlang-solutions.com/site/esl/esl-erlang/FLAVOUR_1_general/esl-erlang_21.0-1~ubuntu~xenial_amd64.deb
# install it
sudo dpkg -i esl-erlang_21.0-1~ubuntu~xenial_amd64.deb
```

##### Erlang Version Pinning

https://wiki.debian.org/AptPreferences
https://www.debian.org/doc/debian-policy/#document-ch-controlfields
https://help.ubuntu.com/community/PinningHowto
    **NOTE**:
    
    When pinning, you must ensure compatibility of packages by yourself since Debian does not guarantee it. Note that pinning is completely optional, and Debian does not encourage pinning without thorough consideration.

    /!\ Seriously, don't do this. Doing this will break Debian and leave you with a system that doesn't work and can't be fixed. Use Backports instead!


https://wiki.debian.org/AptPreferences
https://wiki.debian.org/Backports

apt package pinning can be used to avoid undesired Erlang upgrades

In `/etc/apt/preferences.d/erlang` file:

```sh
sudo joe /etc/apt/preferences.d/erlang
# add <START>

# pin esl-erlang package to to 20.3.6 (assuming package epoch for the package is 1)
Package: esl-erlang
Pin: version 1:20.3.6
Pin-Priority: 1000

# pin all erlang-* packages (in other words, all Erlang packages in the standard Debian and Ubuntu repositories) to 20.3 (assuming package epoch for the package is 1):
Package: erlang*
Pin: version 1:20.3-1
Pin-Priority: 1000

# </STOP>

sudo apt-cache policy
sudo apt-get upgrade
sudo apt-get -f upgrade
sudo apt autoremove
```

##### RabbitMQ

Add the Apt repository to your Apt source list 

+ https://www.rabbitmq.com/cli.html
+ [AMQP 0-9-1 Model Explained](https://www.rabbitmq.com/tutorials/amqp-concepts.html)
+ [AMQP 0-9-1 Complete Reference Guide](https://www.rabbitmq.com/amqp-0-9-1-reference.html#domain.peer-properties)
+ [AMQP version 0­9­1 specification](https://www.rabbitmq.com/resources/specs/amqp-xml-doc0-9-1.pdf)

```sh
# generic (example, do not run)
sudo echo "deb https://dl.bintray.com/rabbitmq/debian {distribution} main" | sudo tee /etc/apt/sources.list.d/bintray.rabbitmq.list
# for the xenial distribution
sudo echo "deb https://dl.bintray.com/rabbitmq/debian xenial main" | sudo tee /etc/apt/sources.list.d/bintray.rabbitmq.list
```

```sh
# Add RabbitMQ public key to your trusted key list using apt-key(8)
wget -O- https://dl.bintray.com/rabbitmq/Keys/rabbitmq-release-signing-key.asc | sudo apt-key add -
# update the package list
sudo apt-get update
# Install rabbitmq-server package
sudo apt-get install rabbitmq-server

sudo service rabbitmq-server status

# control
sudo rabbitmqctl status
sudo rabbitmqctl stop
sudo rabbitmqctl list_queues
sudo rabbitmqctl list_exchanges
```

Web management console available at port 15672

##### OSX

https://www.rabbitmq.com/install-homebrew.html
https://www.rabbitmq.com/install-standalone-mac.html

```sh
brew update
brew install rabbitmq
# add
# PATH=$PATH:/usr/local/sbin to
# your .bash_profile or .profile.
vim ~/.bash_profile
 /usr/local/sbin/rabbitmq-server
```

##### Management

https://nixmash.com/post/installing-rabbitmqadmin-command-line-tool-in-ubuntu

```sh
sudo rabbitmq-plugins enable rabbitmq_management
lynx http://localhost:15672
```


#### Authorization/Authentication

+ https://www.rabbitmq.com/authentication.html
+ https://www.rabbitmq.com/access-control.html
+ https://www.rabbitmq.com/configure.html
+ https://www.rabbitmq.com/rabbitmqctl.8.html#add_user
+ [Adding new user](https://stackoverflow.com/questions/22850546/cant-access-rabbitmq-web-management-interface-after-fresh-install/22854222#22854222)
+ https://stackoverflow.com/a/41286189

```sh
sudo rabbitmqctl add_user colabo colabo_usr56
sudo rabbitmqctl set_user_tags colabo administrator
sudo rabbitmqctl set_permissions -p / colabo ".*" ".*" ".*"
# connection url is now: `amqp://colabo:colabo_usr56@158.39.75.31:5672`
```

ok, proradila je komunikacija 
- iz node.js (na colabo-space-1, 158.39.75.120, tu je colabo.space glavni kod)
- preko RabbitMQ (na orchestrator, 158.39.75.31) 
- do python-a (na colabo-service-1, 158.39.75.130, tu je lazin kod)

#### Logs

```
cat /etc/logrotate.d/rabbitmq-server
sudo ls /var/log/rabbitmq
```

#### Development

+ https://github.com/squaremo/amqp.node/tree/master/examples/tutorials
#### Python

https://pika.readthedocs.io/en/stable/modules/parameters.html
https://pika.readthedocs.io/en/stable/modules/parameters.html#pika.connection.URLParameters
https://www.cloudamqp.com/blog/2015-05-21-part2-3-rabbitmq-for-beginners_example-and-sample-code-python.html

```sh
sudo apt-get install python-pip
python -m pip install --upgrade pip
# install RabbitMQ implementation
python -m pip install pika
```

`send.py`

```py
#!/usr/bin/env python
import pika

connection = pika.BlockingConnection(pika.ConnectionParameters(host='localhost'))

channel = connection.channel()
channel.queue_declare(queue='hello')

channel.basic_publish(exchange='', routing_key='hello', body='Hello World!')
print(" [x] Sent 'Hello World!'")

connection.close()
```

`receive.py`

```py
#!/usr/bin/env python
import pika

connection = pika.BlockingConnection(pika.ConnectionParameters(host='localhost'))

channel = connection.channel()
channel.queue_declare(queue='hello')

def callback(ch, method, properties, body):
    print(" [x] Received %r" % body)

channel.basic_consume(callback, queue='hello', no_ack=True)

print(' [*] Waiting for messages. To exit press CTRL+C')

channel.start_consuming()
```

#### Node.js

https://www.npmjs.com/package/amqplib
